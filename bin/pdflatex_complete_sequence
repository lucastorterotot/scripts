#!/bin/bash

nbcompilmax=5
for arg in "$@"; do
    directory=$(dirname $arg)
    argnotex=${arg%.*}
    file=$(basename $argnotex)
    nbcompil=1
    continue_workflow=1
    pdflatex -draftmode -interaction=batchmode -halt-on-error $argnotex || continue_workflow=0
    if [[ $continue_workflow == 0 ]]
    then
        printf "\n\tPdfLaTeX failed at run $nbcompil.\n\tFile: $arg\n\n"
        break
    fi
    sleep 0.25
    if [ -e $file.bcf ]
    then
        biber $file
    elif [ -e $file-blx.bib ] && [ -e $file.aux ] 
    then
        bibtex $file.aux
    fi &
    if [ -e $file.idx ]
    then
        makeindex $file.idx
    fi &
    feynmp_compil &
    wait
    sleep 0.25
    while [[ $(grep -l $file.log -e 'Rerun to get cross-references right' -e 'undefined references' -e 'undefined on input line') == $file.log ]] && ((nbcompil < nbcompilmax)) && [[ $continue_workflow == 1 ]]; do
        ((nbcompil++))
        printf '\n\t' ; printf "PdfLaTeX run $nbcompil...\n\n"
        pdflatex -interaction=batchmode -halt-on-error $argnotex || continue_workflow=0
    done
    if [[ $continue_workflow == 0 ]]
    then
        printf "\n\tPdfLaTeX failed at run $nbcompil.\n\tFile: $arg\n\n"
        break
    fi
    printf '\n\t' ; printf $nbcompil ; printf ' compilations.\n\n'
    rm -f *.1 *.mp *.t1 &
    rm -f $file.aux $file.out $file.toc $file.lof $file.nav $file.snm $file.synctex.gz $file.maf $file.mtc $file.ptc $file.bcf $file.bbl $file.run.xml $file-blx.bib $file.idx $file.ilg $file.ind &
    rm -f $file-*.cpt &
    wait
done
